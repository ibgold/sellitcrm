<!DOCTYPE html>
<html lang="fr" class="h-full bg-gray-50">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sell It - CRM</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- FontAwesome pour les ic√¥nes (Ghost, Eclair, etc.) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { font-family: 'Plus Jakarta Sans', sans-serif; }
        .custom-scroll::-webkit-scrollbar { width: 5px; height: 5px; }
        .custom-scroll::-webkit-scrollbar-track { background: transparent; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .slide-over { transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
        .fade-in { animation: fadeIn 0.4s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Styles sp√©cifiques pour le formulaire "Clean" */
        .form-input {
            @apply block w-full border-0 border-b-2 border-gray-200 bg-transparent py-2.5 px-0 text-sm text-gray-900 focus:border-accent focus:ring-0 transition-colors placeholder-gray-400;
        }
        .form-label {
            @apply absolute top-0 left-0 -mt-3.5 text-xs font-medium text-gray-500 transition-all peer-placeholder-shown:top-2.5 peer-placeholder-shown:text-sm peer-focus:-mt-3.5 peer-focus:text-xs peer-focus:text-accent;
        }
        .status-checkbox-wrapper {
            @apply flex items-center space-x-2 cursor-pointer select-none px-3 py-2 rounded-lg border border-transparent hover:bg-gray-50 transition-all;
        }
        .status-checkbox {
            @apply h-4 w-4 rounded border-gray-300 text-accent focus:ring-accent;
        }
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: { primary: '#0f172a', accent: '#4f46e5', success: '#10b981', danger: '#ef4444', warning: '#f59e0b' },
                    boxShadow: { 'soft': '0 4px 6px -1px rgba(0, 0, 0, 0.02), 0 2px 4px -1px rgba(0, 0, 0, 0.02)' }
                }
            }
        }
    </script>
</head>
<body class="h-full overflow-hidden text-slate-600 font-medium">

    <!-- LOGIN SCREEN -->
    <div id="login-screen" class="fixed inset-0 z-[100] bg-primary flex items-center justify-center">
        <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-sm mx-4 text-center fade-in">
            <div class="mb-6 flex justify-center items-center gap-2">
                <div class="h-10 w-10 bg-accent rounded-lg flex items-center justify-center text-white font-bold text-xl shadow-lg">S</div>
                <h1 class="text-2xl font-bold text-slate-800">Sell It <span class="text-accent">CRM</span></h1>
            </div>
            <form id="login-form" class="space-y-4 text-left">
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Identifiant</label>
                    <input type="text" id="login-user" class="w-full p-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-accent focus:border-accent transition-all" placeholder="Votre pseudo">
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Mot de passe</label>
                    <input type="password" id="login-pass" class="w-full p-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-accent focus:border-accent transition-all" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                </div>
                <div id="login-error" class="text-danger text-xs hidden text-center font-bold">Identifiants incorrects.</div>
                <button type="submit" id="login-btn" class="w-full py-3.5 bg-primary text-white rounded-xl font-bold hover:bg-slate-800 transition-all shadow-lg">Se Connecter</button>
            </form>
        </div>
    </div>

    <!-- APP CONTENT -->
    <div id="app-content" class="hidden h-full flex w-full">
        <!-- SIDEBAR -->
        <div class="hidden md:flex md:w-64 md:flex-col md:fixed md:inset-y-0 bg-primary shadow-xl z-50">
            <div class="flex flex-col flex-1 min-h-0">
                <div class="flex items-center h-20 px-6 bg-primary border-b border-slate-800 gap-3">
                    <div class="h-8 w-8 bg-accent rounded-lg flex items-center justify-center text-white font-bold shadow-md">S</div>
                    <span class="text-lg font-bold text-white tracking-wide">Sell It <span class="text-accent">CRM</span></span>
                </div>
                <div class="flex-1 py-6 px-4 space-y-2 overflow-y-auto">
                    <button onclick="switchView('dashboard')" id="nav-dashboard" class="w-full group flex items-center px-3 py-3 text-sm font-medium rounded-xl transition-all duration-200 bg-indigo-600/10 text-indigo-300 border border-indigo-500/20">
                        <svg class="mr-3 h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/></svg> Pipeline
                    </button>
                    <button onclick="switchView('stats')" id="nav-stats" class="w-full group flex items-center px-3 py-3 text-sm font-medium rounded-xl text-slate-400 hover:bg-slate-800 hover:text-white transition-all duration-200">
                        <svg class="mr-3 h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 12l3-3 3 3 4-4M8 21l4-4 4 4M3 4h18M4 4h16v12a1 1 0 01-1 1H5a1 1 0 01-1-1V4z" /></svg> Statistiques
                    </button>
                </div>
                <div class="p-4 border-t border-slate-800">
                    <div class="flex items-center justify-between mb-2"><p class="text-xs font-bold text-white truncate w-24" id="user-display">User</p><span class="text-[10px] bg-slate-700 text-slate-300 px-1.5 py-0.5 rounded" id="role-display">Role</span></div>
                    <p class="text-[10px] text-slate-500 mb-3 truncate" id="org-display">Org</p>
                    <button onclick="logout()" class="w-full py-2 text-xs text-red-400 hover:text-red-300 hover:bg-slate-800 rounded-lg border border-slate-700">D√©connexion</button>
                </div>
            </div>
        </div>

        <!-- MAIN -->
        <div class="md:pl-64 flex flex-col flex-1 h-full overflow-hidden relative bg-gray-50">
            <!-- TOPBAR -->
            <div class="h-16 flex items-center justify-between px-8 border-b border-gray-200 bg-white/80 backdrop-blur-md sticky top-0 z-20">
                <h2 class="text-lg font-bold text-slate-800" id="page-title">Pipeline</h2>
                
                <div class="flex items-center gap-4">
                    <!-- 1. S√©lecteur Organisation (Pour Super Admin) -->
                    <div id="superadmin-selector-container" class="hidden">
                        <select id="superadmin-org-selector" class="text-xs font-bold text-slate-700 bg-white border border-slate-300 rounded-lg py-2 px-3 shadow-sm focus:ring-accent cursor-pointer">
                            <option value="">Choisir Client...</option>
                        </select>
                    </div>

                    <!-- 2. S√©lecteur √âquipe (Pour Manager & Super Admin) -->
                    <div id="manager-selector-container" class="hidden">
                        <select id="manager-view-selector" class="text-xs font-bold text-indigo-700 bg-indigo-50 border border-indigo-100 rounded-lg py-2 px-3 focus:ring-indigo-500 cursor-pointer">
                            <option value="ALL">Vue Globale (√âquipe)</option>
                        </select>
                    </div>

                    <button onclick="openSlideOver()" id="btn-add-deal" class="px-4 py-2 text-sm font-bold text-white bg-primary rounded-lg shadow-soft hover:bg-slate-800 transition-all">+ Deal</button>
                </div>
            </div>

            <!-- CONTENT -->
            <main class="flex-1 overflow-y-auto p-6 sm:p-8 custom-scroll">
                <!-- DASHBOARD -->
                <div id="view-dashboard" class="space-y-8 fade-in">
                    <div class="grid grid-cols-1 gap-6 sm:grid-cols-3">
                        <div class="bg-white p-6 rounded-2xl shadow-soft border border-gray-100"><p class="text-sm font-medium text-slate-500 mb-1">Total Deals (Vue)</p><p class="text-3xl font-bold text-slate-800" id="metric-total">0</p></div>
                        <div class="bg-white p-6 rounded-2xl shadow-soft border border-gray-100 border-l-4 border-l-indigo-500"><p class="text-sm font-medium text-indigo-600 mb-1 font-bold">√Ä Relancer</p><p class="text-3xl font-bold text-indigo-600" id="metric-followup">0</p></div>
                        <div class="bg-white p-6 rounded-2xl shadow-soft border border-gray-100 border-l-4 border-l-emerald-500"><p class="text-sm font-medium text-emerald-600 mb-1 font-bold">Clos√©s</p><p class="text-3xl font-bold text-emerald-600" id="metric-closed">0</p></div>
                    </div>
                    <div class="bg-white shadow-soft rounded-2xl border border-gray-100 overflow-hidden">
                        <div class="p-4 border-b border-gray-100 flex gap-3 overflow-x-auto items-center">
                            <select id="filter-month" class="text-sm border-gray-200 rounded-lg py-2 pl-3 pr-8 font-medium text-slate-700 focus:ring-accent"><option value="current">Ce mois</option><option value="all">Tout</option></select>
                            <select id="filter-status" class="text-sm border-gray-200 rounded-lg py-2 pl-3 pr-8 font-medium text-slate-700 focus:ring-accent"><option value="all">Tous statuts</option><option value="followup">‚ö° Relance</option><option value="closed">üí∞ Clos√©</option></select>
                            <div class="flex-1"></div>
                            <button id="reset-filters" class="text-xs font-bold text-slate-400 hover:text-accent uppercase">Reset</button>
                        </div>
                        <div class="overflow-x-auto min-h-[400px] relative">
                            <div id="loading-indicator" class="hidden absolute inset-0 bg-white/80 z-10 flex items-center justify-center"><div class="w-8 h-8 border-4 border-indigo-100 border-t-accent rounded-full animate-spin"></div></div>
                            <div id="no-data-message" class="hidden absolute inset-0 flex items-center justify-center text-slate-400 text-sm">Aucun r√©sultat.</div>
                            <table class="min-w-full divide-y divide-gray-100"><thead class="bg-gray-50/50"><tr><th class="px-6 py-4 text-left text-xs font-bold text-slate-400 uppercase">Prospect</th><th class="px-6 py-4 text-left text-xs font-bold text-slate-400 uppercase">Date</th><th class="px-6 py-4 text-left text-xs font-bold text-slate-400 uppercase">Offre</th><th class="px-6 py-4 text-left text-xs font-bold text-slate-400 uppercase">Statut</th><th class="px-6 py-4 text-right"></th></tr></thead><tbody id="deals-table-body" class="divide-y divide-gray-50 bg-white"></tbody></table>
                        </div>
                    </div>
                </div>
                <!-- STATS -->
                <div id="view-stats" class="hidden space-y-8 fade-in">
                    <div class="bg-white rounded-2xl shadow-soft border border-gray-100 overflow-hidden"><div class="px-6 py-4 border-b border-gray-100 bg-gray-50/30"><h3 class="font-bold text-slate-800 flex items-center gap-2"><span class="w-1 h-4 bg-accent rounded-full"></span> Performance Mensuelle</h3></div><div class="overflow-x-auto"><table class="min-w-full text-sm"><thead class="bg-primary text-white"><tr><th class="p-3 text-left">Mois</th><th class="p-3 text-center opacity-80">RDV</th><th class="p-3 text-center opacity-80">Pr√©s.</th><th class="p-3 text-center text-blue-300">% Pr√©s.</th><th class="p-3 text-center text-emerald-400">Wins</th><th class="p-3 text-center text-indigo-300">% Conv.</th><th class="p-3 text-right text-warning">CA</th></tr></thead><tbody id="stats-month-body"></tbody></table></div></div>
                    <div class="bg-white rounded-2xl shadow-soft border border-gray-100 overflow-hidden"><div class="px-6 py-4 border-b border-gray-100 bg-gray-50/30 flex justify-between items-center"><h3 class="font-bold text-slate-800 flex items-center gap-2"><span class="w-1 h-4 bg-warning rounded-full"></span> Performance Hebdomadaire</h3><select id="stats-weekly-month-filter" class="text-xs border-gray-200 rounded py-1"><option value="all">Tout</option></select></div><div class="overflow-x-auto"><table class="min-w-full text-sm"><thead class="bg-primary text-white"><tr><th class="p-3 text-left">Semaine</th><th class="p-3 text-center opacity-80">RDV</th><th class="p-3 text-center opacity-80">Pr√©s.</th><th class="p-3 text-center text-blue-300">% Pr√©s.</th><th class="p-3 text-center text-emerald-400">Wins</th><th class="p-3 text-center text-indigo-300">% Conv.</th><th class="p-3 text-right text-warning">CA</th></tr></thead><tbody id="stats-weekly-body"></tbody></table></div></div>
                    <div class="bg-white rounded-2xl shadow-soft border border-gray-100 overflow-hidden"><div class="px-6 py-4 border-b border-gray-100 bg-gray-50/30 flex justify-between items-center"><h3 class="font-bold text-slate-800 flex items-center gap-2"><span class="w-1 h-4 bg-purple-500 rounded-full"></span> Par Source</h3><select id="stats-source-month-filter" class="text-xs border-gray-200 rounded py-1"><option value="all">Tout</option></select></div><div class="overflow-x-auto"><table class="min-w-full text-sm"><thead class="bg-primary text-white"><tr><th class="p-3 text-left">Source</th><th class="p-3 text-center opacity-80">RDV</th><th class="p-3 text-center opacity-80">Pr√©s.</th><th class="p-3 text-center text-blue-300">% Pr√©s.</th><th class="p-3 text-center text-emerald-400">Wins</th><th class="p-3 text-center text-indigo-300">% Conv.</th><th class="p-3 text-right text-warning">CA</th></tr></thead><tbody id="stats-source-body"></tbody></table></div></div>
                </div>
            </main>
        </div>
    </div>

    <!-- SLIDE OVER (FORMULAIRE REDESIGN√â "CLEAN") -->
    <div id="slide-over-container" class="hidden fixed inset-0 z-50 overflow-hidden">
        <div class="absolute inset-0 bg-primary/40 backdrop-blur-sm transition-opacity" onclick="closeSlideOver()"></div>
        <div id="slide-over-panel" class="absolute inset-y-0 right-0 max-w-md w-full bg-white shadow-2xl flex flex-col transform transition-transform translate-x-full">
            
            <!-- HEADER -->
            <div class="px-8 py-6 border-b border-gray-100 flex justify-between items-center bg-white">
                <div>
                    <h2 class="text-xl font-bold text-slate-800" id="slide-over-title">Deal Details</h2>
                    <p class="text-xs text-slate-400 mt-1">Remplissez les informations cl√©s ci-dessous.</p>
                </div>
                <button onclick="closeSlideOver()" class="text-slate-400 hover:text-slate-600 transition-colors p-2 rounded-full hover:bg-gray-50">
                    <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/></svg>
                </button>
            </div>
            
            <form id="deal-form" class="flex-1 flex flex-col overflow-y-auto custom-scroll bg-white">
                <div class="px-8 py-6 space-y-8">
                    
                    <!-- 1. IDENTIT√â -->
                    <div class="space-y-6">
                        <div class="relative">
                            <input type="text" id="nomPrenom" required class="form-input peer" placeholder=" ">
                            <label for="nomPrenom" class="form-label">Prospect <span class="text-red-500">*</span></label>
                        </div>

                        <div class="grid grid-cols-2 gap-6">
                            <div class="relative">
                                <select id="source" required class="form-input peer pt-3 pb-2"><option value="Marketing">Marketing</option><option value="Setting">Setting</option><option value="Prise de rdv">Prise de RDV</option><option value="Autre">Autre</option></select>
                                <label for="source" class="form-label">Source</label>
                            </div>
                            <div class="relative">
                                <input type="text" id="entrepreneur" class="form-input peer" placeholder=" ">
                                <label for="entrepreneur" class="form-label">Entrepreneur (F)</label>
                            </div>
                        </div>

                        <div class="relative">
                            <input type="date" id="dateRDV" class="form-input peer pt-3 pb-2">
                            <label for="dateRDV" class="form-label">Date RDV</label>
                        </div>

                        <div class="grid grid-cols-2 gap-6">
                            <div class="relative">
                                <input type="email" id="email" class="form-input peer" placeholder=" ">
                                <label for="email" class="form-label">Email</label>
                            </div>
                            <div class="relative">
                                <input type="text" id="numero" class="form-input peer" placeholder=" ">
                                <label for="numero" class="form-label">T√©l√©phone</label>
                            </div>
                        </div>

                        <div class="relative">
                            <input type="url" id="enregistrementCall" class="form-input peer" placeholder=" ">
                            <label for="enregistrementCall" class="form-label">Lien Enregistrement (URL)</label>
                        </div>
                    </div>

                    <!-- 2. STATUTS (DESIGN CARTE) -->
                    <div class="bg-gray-50 rounded-xl p-5 border border-gray-100">
                        <div class="flex items-center justify-between mb-4">
                            <label class="flex items-center cursor-pointer w-full p-3 bg-emerald-50 border border-emerald-100 rounded-lg hover:shadow-sm transition-all group">
                                <input id="close" type="checkbox" class="h-5 w-5 text-emerald-600 rounded focus:ring-emerald-500 border-gray-300">
                                <span class="ml-3 font-bold text-emerald-800">‚úÖ Deal Clos√©</span>
                            </label>
                        </div>

                        <div class="grid grid-cols-2 gap-3">
                            <label class="status-checkbox-wrapper group">
                                <input id="aFollowUp" type="checkbox" class="status-checkbox">
                                <span class="text-xs font-semibold text-indigo-600 flex items-center gap-2"><i class="fa-solid fa-bolt"></i> Relance</span>
                            </label>
                            <label class="status-checkbox-wrapper group">
                                <input id="ghost" type="checkbox" class="status-checkbox !text-amber-500 !focus:ring-amber-500">
                                <span class="text-xs font-semibold text-amber-600 flex items-center gap-2"><i class="fa-solid fa-ghost"></i> Ghost</span>
                            </label>
                            <label class="status-checkbox-wrapper group">
                                <input id="nonClose" type="checkbox" class="status-checkbox !text-red-500 !focus:ring-red-500">
                                <span class="text-xs font-semibold text-red-600 flex items-center gap-2"><i class="fa-solid fa-xmark"></i> Perdu</span>
                            </label>
                            <label class="status-checkbox-wrapper group">
                                <input id="compta" type="checkbox" class="status-checkbox !text-teal-500 !focus:ring-teal-500">
                                <span class="text-xs font-semibold text-teal-600 flex items-center gap-2"><i class="fa-solid fa-book"></i> Compta</span>
                            </label>
                        </div>
                    </div>

                    <!-- 3. DETAILS CLOSING (Conditionnel) -->
                    <div id="closing-details" class="hidden space-y-6 pt-2 fade-in">
                        <div class="relative">
                            <select id="formation" class="form-input peer pt-3 pb-2"><option value="">S√©lectionner...</option><option value="Produit B 4000">Produit B (4000‚Ç¨)</option><option value="Produit A 2000">Produit A (2000‚Ç¨)</option><option value="N/A">Autre</option></select>
                            <label for="formation" class="form-label text-emerald-600">Produit Vendu</label>
                        </div>
                        <div class="grid grid-cols-2 gap-6">
                            <div class="relative"><input type="number" id="prix" class="form-input peer" placeholder=" "><label for="prix" class="form-label text-emerald-600">Prix (‚Ç¨)</label></div>
                            <div class="relative"><input type="number" id="mensualite" class="form-input peer" placeholder=" "><label for="mensualite" class="form-label text-emerald-600">Mensualit√©</label></div>
                        </div>
                        <div class="relative">
                            <select id="typePaiement" class="form-input peer pt-3 pb-2"><option value="">S√©lectionner...</option><option value="CB">Carte Bancaire</option><option value="Virement">Virement</option><option value="3x">3 Fois</option><option value="Int√©gral">Int√©gral</option></select>
                            <label for="typePaiement" class="form-label text-emerald-600">Moyen de Paiement</label>
                        </div>
                    </div>

                    <!-- 4. NOTES -->
                    <div class="relative">
                        <textarea id="newComment" rows="3" class="form-input peer resize-none" placeholder=" "></textarea>
                        <label for="newComment" class="form-label">Note / Commentaire</label>
                        <div id="comment-history" class="mt-4 hidden p-3 bg-gray-50 rounded-lg border border-gray-100 text-xs text-slate-500 max-h-32 overflow-y-auto"></div>
                    </div>

                </div>
                
                <!-- FOOTER -->
                <div class="p-6 border-t border-gray-100 flex justify-end gap-3 bg-white sticky bottom-0">
                    <button type="button" onclick="closeSlideOver()" class="px-5 py-2.5 rounded-xl text-sm font-bold text-slate-500 hover:text-slate-800 hover:bg-gray-50 transition-colors">Annuler</button>
                    <button type="submit" id="submit-text" class="px-8 py-2.5 rounded-xl text-sm font-bold text-white bg-primary hover:bg-slate-800 shadow-lg shadow-primary/20 transition-all transform hover:-translate-y-0.5">Enregistrer</button>
                </div>
            </form>
        </div>
    </div>
    <!-- History Modal -->
    <div id="history-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4"><div class="absolute inset-0 bg-primary/60 backdrop-blur-sm" onclick="document.getElementById('history-modal').classList.add('hidden')"></div><div class="relative bg-white rounded-2xl shadow-2xl w-full max-w-lg overflow-hidden"><div class="p-4 border-b border-gray-100 font-bold text-slate-800">Historique</div><div id="modal-history-content" class="p-6 text-sm text-slate-600 max-h-96 overflow-y-auto bg-gray-50"></div><div class="p-4 border-t border-gray-100 flex justify-end"><button onclick="document.getElementById('history-modal').classList.add('hidden')" class="text-sm font-bold text-slate-500 hover:text-slate-800">Fermer</button></div></div></div>

    <script>
        const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzZzTCbYR2H4jsGfrZt60oxhmwgf8D_wS8QSgO4GggLoECqsPP9LctDITbWgb6oBZQh/exec'; 

        let allDealsCache = []; 
        let currentUser = null; 
        let currentSheetId = localStorage.getItem('crm_sheetId');
        let currentUserName = localStorage.getItem('crm_user');

        // --- AUTH & INIT ---
        function checkAuth() {
            if (currentSheetId && currentUserName) {
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('app-content').classList.remove('hidden');
                document.getElementById('user-display').textContent = currentUserName;
                loadDeals();
            } else {
                document.getElementById('login-screen').classList.remove('hidden');
                document.getElementById('app-content').classList.add('hidden');
            }
        }

        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const u = document.getElementById('login-user').value.trim();
            const p = document.getElementById('login-pass').value.trim();
            const btn = document.getElementById('login-btn');
            
            btn.textContent = "Connexion..."; btn.disabled = true;
            try {
                const response = await fetch(APPS_SCRIPT_URL, {
                    method: 'POST', mode: 'cors', cache: 'no-cache', headers: { 'Content-Type': 'text/plain' },
                    body: JSON.stringify({ action: 'LOGIN', username: u, password: p })
                });
                const result = await response.json();
                
                if (result.success) {
                    localStorage.setItem('crm_sheetId', result.sheetId);
                    localStorage.setItem('crm_user', result.name);
                    currentSheetId = result.sheetId;
                    currentUserName = result.name;
                    checkAuth();
                } else {
                    document.getElementById('login-error').classList.remove('hidden');
                }
            } catch (e) {
                alert("Erreur connexion serveur");
            } finally {
                btn.disabled = false; btn.textContent = "Se Connecter";
            }
        });

        function logout() {
            localStorage.clear();
            location.reload();
        }

        // --- DATA LOADING (With Sheet ID) ---
        async function fetchAppsScript(action, data = {}) {
            if(action !== 'LOGIN') data.targetSheetId = currentSheetId;
            if (action === 'READ' && currentSheetId === 'ALL') data.org = currentUser.org; 

            if (action !== 'READ' && action !== 'LOGIN') { 
                const btn = document.getElementById('submit-text');
                if(btn) { btn.disabled = true; btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin mr-2"></i> Traitement...'; }
            }
            try {
                const response = await fetch(APPS_SCRIPT_URL, { method: 'POST', mode: 'cors', cache: 'no-cache', headers: { 'Content-Type': 'text/plain' }, body: JSON.stringify({ action, ...data }) });
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                const result = await response.json();
                if (!result.success) throw new Error(result.error || result.message);
                return result;
            } catch (error) {
                console.error(error); alert(`Erreur: ${error.message}`); return { success: false, error: error.message };
            } finally { 
                 if (action !== 'READ' && action !== 'LOGIN') { 
                    const btn = document.getElementById('submit-text');
                    if(btn) { btn.disabled = false; btn.textContent = "Enregistrer"; }
                } 
            }
        }

        async function loadDeals() {
            if(!currentSheetId) return; 
            document.getElementById('loading-indicator').classList.remove('hidden');
            try {
                const res = await fetchAppsScript('READ');
                if (res.success) {
                    allDealsCache = (res.deals || []).filter(d => d.nomPrenom && String(d.nomPrenom).trim() !== "");
                    renderAll();
                }
            } catch(e) { console.error(e); }
            document.getElementById('loading-indicator').classList.add('hidden');
        }

        // --- HELPERS ---
        function getWeekNumber(d) {
            d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
            d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay()||7));
            var yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1));
            return Math.ceil(( ( (d - yearStart) / 86400000) + 1)/7);
        }

        // --- NAVIGATION ---
        function switchView(viewId) {
            document.getElementById('view-dashboard').classList.add('hidden');
            document.getElementById('view-stats').classList.add('hidden');
            const target = document.getElementById(`view-${viewId}`);
            target.classList.remove('hidden');
            document.getElementById('page-title').textContent = viewId === 'dashboard' ? 'Tableau de Bord' : 'Rapports & Statistiques';
            const topbarActions = document.getElementById('topbar-actions');
            if(viewId === 'stats') topbarActions.classList.add('hidden'); else topbarActions.classList.remove('hidden');
            const allNavs = document.querySelectorAll('div > nav > button');
            allNavs.forEach(btn => { btn.className = "w-full group flex items-center px-3 py-2.5 text-sm font-medium rounded-xl transition-all duration-200 bg-indigo-600/10 text-indigo-300 border border-indigo-500/20"; btn.classList.remove('bg-indigo-600/10','text-indigo-300','border-indigo-500/20'); btn.classList.add('text-slate-400','hover:bg-slate-800','hover:text-white'); });
            const activeBtn = document.getElementById(`nav-${viewId}`);
            activeBtn.classList.remove('text-slate-400','hover:bg-slate-800','hover:text-white');
            activeBtn.classList.add('bg-indigo-600/10','text-indigo-300','border','border-indigo-500/20');
            if(viewId === 'stats') renderStats();
        }

        // --- STATS ---
        function renderStats() {
            // (M√™me logique stats qu'avant, compress√©e pour l'espace)
            const monthStats = {}; const monthsOrder = ['janvier', 'f√©vrier', 'mars', 'avril', 'mai', 'juin', 'juillet', 'ao√ªt', 'septembre', 'octobre', 'novembre', 'd√©cembre'];
            monthsOrder.forEach(m => monthStats[m] = { rdv: 0, pres: 0, win: 0, ca: 0 });
            const sourceStats = {}; const weekStats = {};
            allDealsCache.forEach(d => {
                if(!d.dateRDV) return; const date = new Date(d.dateRDV); const mName = date.toLocaleString('fr-FR', { month: 'long' }); const wNum = getWeekNumber(date); const sName = d.source || 'Inconnu';
                if(monthStats[mName]) { monthStats[mName].rdv++; if(!d.ghost) monthStats[mName].pres++; if(d.close) { monthStats[mName].win++; monthStats[mName].ca += (d.prix || 0); } }
                if(!sourceStats[sName]) sourceStats[sName] = { rdv: 0, pres: 0, win: 0, ca: 0 }; sourceStats[sName].rdv++; if(!d.ghost) sourceStats[sName].pres++; if(d.close) { sourceStats[sName].win++; sourceStats[sName].ca += (d.prix || 0); }
                const wKey = `S${wNum}`; if(!weekStats[wKey]) weekStats[wKey] = { rdv: 0, pres: 0, win: 0, ca: 0 }; weekStats[wKey].rdv++; if(!d.ghost) weekStats[wKey].pres++; if(d.close) { weekStats[wKey].win++; weekStats[wKey].ca += (d.prix || 0); }
            });
            const makeRow = (label, s) => { const txPres = s.rdv ? Math.round((s.pres/s.rdv)*100)+'%' : '-'; const txConv = s.pres ? Math.round((s.win/s.pres)*100)+'%' : '-'; return `<tr class="border-b border-gray-50 hover:bg-gray-50"><td class="p-3 font-bold text-slate-700 capitalize">${label}</td><td class="p-3 text-center text-slate-500">${s.rdv}</td><td class="p-3 text-center text-slate-500">${s.pres}</td><td class="p-3 text-center text-blue-500 font-bold">${txPres}</td><td class="p-3 text-center text-emerald-500 font-bold">${s.win}</td><td class="p-3 text-center text-indigo-500 font-bold">${txConv}</td><td class="p-3 text-right font-mono text-warning font-bold">${s.ca > 0 ? s.ca + ' ‚Ç¨' : '-'}</td></tr>`; };
            document.getElementById('stats-month-body').innerHTML = monthsOrder.map(m => makeRow(m, monthStats[m])).join('');
            document.getElementById('stats-source-body').innerHTML = Object.keys(sourceStats).map(k => makeRow(k, sourceStats[k])).join('');
            document.getElementById('stats-weekly-body').innerHTML = Object.keys(weekStats).sort((a,b) => parseInt(a.slice(1)) - parseInt(b.slice(1))).map(k => makeRow(k, weekStats[k])).join('');
        }

        // --- ACTIONS ---
        function openSlideOver() { resetForm(); document.getElementById('slide-over-container').classList.remove('hidden'); setTimeout(() => { document.getElementById('slide-over-panel').classList.remove('translate-x-full'); }, 10); }
        function closeSlideOver() { document.getElementById('slide-over-panel').classList.add('translate-x-full'); setTimeout(() => { document.getElementById('slide-over-container').classList.add('hidden'); }, 300); }

        document.getElementById('deal-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const data = {
                id: editingId,
                nomPrenom: document.getElementById('nomPrenom').value,
                source: document.getElementById('source').value,
                entrepreneur: document.getElementById('entrepreneur').value,
                dateRDV: document.getElementById('dateRDV').value,
                email: document.getElementById('email').value,
                numero: document.getElementById('numero').value,
                enregistrementCall: document.getElementById('enregistrementCall').value,
                close: document.getElementById('close').checked,
                aFollowUp: document.getElementById('aFollowUp').checked,
                ghost: document.getElementById('ghost').checked,
                nonClose: document.getElementById('nonClose').checked,
                compta: document.getElementById('compta').checked,
                formation: document.getElementById('formation').value,
                prix: parseFloat(document.getElementById('prix').value)||0,
                typePaiement: document.getElementById('typePaiement').value,
                mensualite: parseFloat(document.getElementById('mensualite').value)||0,
                newCommentText: editingId ? document.getElementById('newComment').value : null,
                commentaireHistory: !editingId ? document.getElementById('newComment').value : null
            };
            
            const res = await fetchAppsScript(editingId ? 'UPDATE' : 'CREATE', { data });
            if(res.success) { closeSlideOver(); loadDeals(); }
        });

        window.editDeal = function(id) {
            const d = allDealsCache.find(x => x.id === id); if(!d) return;
            editingId = id;
            document.getElementById('nomPrenom').value = d.nomPrenom;
            document.getElementById('source').value = d.source;
            document.getElementById('entrepreneur').value = d.entrepreneur;
            document.getElementById('dateRDV').value = d.dateRDV;
            document.getElementById('email').value = d.email;
            document.getElementById('numero').value = d.numero;
            document.getElementById('enregistrementCall').value = d.enregistrementCall;
            document.getElementById('close').checked = d.close;
            document.getElementById('aFollowUp').checked = d.aFollowUp;
            document.getElementById('ghost').checked = d.ghost;
            document.getElementById('nonClose').checked = d.nonClose;
            document.getElementById('compta').checked = d.compta;
            toggleClosing();
            document.getElementById('formation').value = d.formation;
            document.getElementById('prix').value = d.prix;
            document.getElementById('typePaiement').value = d.typePaiement;
            document.getElementById('mensualite').value = d.mensualite;
            const hist = document.getElementById('comment-history');
            if(d.commentaireHistory) { hist.textContent = d.commentaireHistory; hist.classList.remove('hidden'); } else hist.classList.add('hidden');
            document.getElementById('newComment').value = '';
            document.getElementById('slide-over-container').classList.remove('hidden');
            setTimeout(() => { document.getElementById('slide-over-panel').classList.remove('translate-x-full'); }, 10);
        };

        window.deleteDeal = async function(id) {
            if(!confirm("Supprimer ?")) return;
            await fetchAppsScript('DELETE', { data: {id} });
            loadDeals();
        };

        window.viewHistory = function(id) {
            const d = allDealsCache.find(x => x.id === id);
            document.getElementById('modal-history-content').textContent = d.commentaireHistory || 'Aucune note';
            document.getElementById('history-modal').classList.remove('hidden');
        };

        // --- HELPERS ---
        function checkMonth(dStr, mode) {
            if(mode === 'all') return true;
            const d = new Date(dStr); const now = new Date();
            return d.getMonth() === now.getMonth() && d.getFullYear() === now.getFullYear();
        }
        function checkStatus(d, s) {
            if(s === 'all') return true;
            if(s === 'followup') return d.aFollowUp;
            if(s === 'closed') return d.close;
            return true;
        }
        function toggleClosing() {
            const div = document.getElementById('closing-details');
            if(document.getElementById('close').checked) div.classList.remove('hidden');
            else div.classList.add('hidden');
        }
        document.getElementById('close').addEventListener('change', toggleClosing);
        
        function resetForm() {
            document.getElementById('deal-form').reset();
            editingId = null; toggleClosing();
            document.getElementById('comment-history').classList.add('hidden');
        }
        function formatDateFR(s) { if(!s) return '-'; const d = new Date(s); return d.toLocaleDateString('fr-FR'); }
        function populateFilters() { /* ... */ }
        document.getElementById('filter-month').addEventListener('change', applyFilters);
        document.getElementById('filter-status').addEventListener('change', applyFilters);
        document.getElementById('reset-filters').addEventListener('click', () => { document.getElementById('filter-month').value = 'current'; document.getElementById('filter-status').value = 'all'; applyFilters(); });

        // --- INIT ---
        initAuth();

    </script>
</body>
</html>
