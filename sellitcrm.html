<!DOCTYPE html>
<html lang="fr" class="h-full bg-slate-900 dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Thoth CRM</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { font-family: 'Plus Jakarta Sans', sans-serif; }
        
        /* Scrollbar */
        .custom-scroll::-webkit-scrollbar { width: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: transparent; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #475569; border-radius: 10px; }
        .custom-scroll::-webkit-scrollbar-thumb:hover { background: #64748b; }
        
        /* Transitions */
        .slide-over { transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
        .fade-in { animation: fadeIn 0.4s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Form Elements - Adaptive Dark/Light */
        .form-input { 
            @apply block w-full border-0 border-b-2 border-slate-200 dark:border-slate-700 bg-transparent py-2.5 px-0 text-sm text-slate-900 dark:text-white focus:border-indigo-500 focus:ring-0 transition-colors placeholder-slate-400; 
        }
        .form-label { 
            @apply absolute top-0 left-0 -mt-3.5 text-xs font-medium text-slate-500 dark:text-slate-400 transition-all peer-placeholder-shown:top-2.5 peer-placeholder-shown:text-sm peer-focus:-mt-3.5 peer-focus:text-xs peer-focus:text-indigo-500 dark:peer-focus:text-indigo-400; 
        }
        
        /* Checkboxes */
        .status-checkbox-wrapper { 
            @apply flex items-center space-x-2 cursor-pointer select-none px-3 py-2 rounded-lg border border-transparent hover:bg-slate-100 dark:hover:bg-slate-700/50 transition-all; 
        }
        .status-checkbox { 
            @apply h-4 w-4 rounded border-slate-300 dark:border-slate-600 text-indigo-600 focus:ring-indigo-500 dark:bg-slate-700; 
        }

        /* Glass Header Effect */
        .glass-header {
            @apply bg-white/80 dark:bg-slate-900/80 border-b border-slate-200 dark:border-slate-800 backdrop-blur-md;
        }

        /* Maximize transition */
        #slide-over-panel { transition: width 0.3s ease, max-width 0.3s ease, transform 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
    </style>
    <script>
        tailwind.config = {
            darkMode: 'class', // Activation du mode sombre manuel
            theme: {
                extend: {
                    colors: {
                        // On garde des noms s√©mantiques mais on utilise les palettes Slate
                    }
                }
            }
        }
    </script>
</head>
<body class="h-full overflow-hidden text-slate-600 dark:text-slate-300 font-medium bg-slate-50 dark:bg-slate-950 transition-colors duration-300">

    <!-- INITIALISATION THEME -->
    <script>
        // Check local storage or system preference
        if (localStorage.getItem('color-theme') === 'dark' || (!('color-theme' in localStorage))) {
            document.documentElement.classList.add('dark');
        } else {
            document.documentElement.classList.remove('dark');
        }
    </script>

    <!-- LOGIN SCREEN -->
    <div id="login-screen" class="fixed inset-0 z-[100] bg-slate-900 flex items-center justify-center">
        <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-2xl p-8 w-full max-w-sm mx-4 text-center fade-in border border-slate-700">
            <div class="mb-8 flex flex-col justify-center items-center gap-2">
                <div class="h-12 w-12 bg-gradient-to-br from-amber-500 to-yellow-600 rounded-xl flex items-center justify-center text-white font-bold text-2xl shadow-lg shadow-amber-500/20">
                    <i class="fa-solid fa-feather"></i> <!-- Plume de Thoth -->
                </div>
                <h1 class="text-3xl font-bold text-slate-800 dark:text-white tracking-tight">THOTH <span class="text-amber-500">CRM</span></h1>
                <p class="text-xs text-slate-500 dark:text-slate-400 uppercase tracking-widest">Knowledge is Power</p>
            </div>
            <form id="login-form" class="space-y-5 text-left">
                <div>
                    <label class="block text-xs font-bold text-slate-500 dark:text-slate-400 uppercase mb-1">Identifiant</label>
                    <input type="text" id="login-user" class="w-full p-3 border border-slate-200 dark:border-slate-600 rounded-xl bg-slate-50 dark:bg-slate-700/50 dark:text-white focus:ring-2 focus:ring-amber-500 focus:border-amber-500 transition-all outline-none" placeholder="Votre pseudo">
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-500 dark:text-slate-400 uppercase mb-1">Mot de passe</label>
                    <input type="password" id="login-pass" class="w-full p-3 border border-slate-200 dark:border-slate-600 rounded-xl bg-slate-50 dark:bg-slate-700/50 dark:text-white focus:ring-2 focus:ring-amber-500 focus:border-amber-500 transition-all outline-none" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                </div>
                <div id="login-error" class="text-white bg-red-500 p-3 rounded-lg text-xs hidden text-center font-bold"></div>
                <button type="submit" id="login-btn" class="w-full py-3.5 bg-slate-900 dark:bg-amber-600 text-white rounded-xl font-bold hover:bg-slate-800 dark:hover:bg-amber-500 transition-all shadow-lg">Se Connecter</button>
            </form>
        </div>
    </div>

    <!-- APP CONTENT -->
    <div id="app-content" class="hidden h-full flex w-full">
        
        <!-- SIDEBAR -->
        <div class="hidden md:flex md:w-72 md:flex-col md:fixed md:inset-y-0 bg-slate-900 border-r border-slate-800 shadow-xl z-50">
            <div class="flex flex-col flex-1 min-h-0">
                <!-- Logo -->
                <div class="flex items-center h-20 px-6 bg-slate-900 border-b border-slate-800 gap-3">
                    <div class="h-8 w-8 bg-gradient-to-br from-amber-500 to-yellow-600 rounded-lg flex items-center justify-center text-white font-bold shadow-md">
                        <i class="fa-solid fa-feather text-sm"></i>
                    </div>
                    <span class="text-xl font-bold text-white tracking-wide">THOTH <span class="text-amber-500">CRM</span></span>
                </div>
                
                <!-- Nav -->
                <div class="flex-1 py-6 px-4 space-y-2 overflow-y-auto">
                    <button onclick="switchView('dashboard')" id="nav-dashboard" class="w-full group flex items-center px-4 py-3 text-sm font-medium rounded-xl transition-all duration-200 bg-slate-800/50 text-amber-400 border border-slate-700/50 shadow-inner">
                        <i class="fa-solid fa-chart-line mr-3 w-5 text-center"></i> Pipeline
                    </button>
                    <button onclick="switchView('stats')" id="nav-stats" class="w-full group flex items-center px-4 py-3 text-sm font-medium rounded-xl text-slate-400 hover:bg-slate-800 hover:text-white transition-all duration-200">
                        <i class="fa-solid fa-chart-pie mr-3 w-5 text-center"></i> Statistiques
                    </button>
                </div>

                <!-- Footer Sidebar -->
                <div class="p-4 border-t border-slate-800 bg-slate-950/30">
                    <div class="flex items-center justify-between mb-3">
                        <p class="text-xs font-bold text-white truncate w-24" id="user-display">User</p>
                        <span class="text-[10px] bg-slate-800 text-slate-400 px-2 py-0.5 rounded border border-slate-700" id="role-display">Role</span>
                    </div>
                    <div class="flex gap-2">
                        <button id="theme-toggle" class="flex-1 py-2 text-xs text-slate-400 hover:text-white bg-slate-800 hover:bg-slate-700 rounded-lg border border-slate-700 transition-colors">
                            <i class="fa-solid fa-moon dark:hidden"></i>
                            <i class="fa-solid fa-sun hidden dark:inline"></i>
                        </button>
                        <button onclick="logout()" class="flex-1 py-2 text-xs text-red-400 hover:text-red-300 bg-slate-800 hover:bg-slate-700 rounded-lg border border-slate-700 transition-colors">Sortir</button>
                    </div>
                    <p class="text-[10px] text-slate-600 mt-2 text-center truncate" id="org-display">Org</p>
                </div>
            </div>
        </div>

        <!-- MAIN -->
        <div class="md:pl-72 flex flex-col flex-1 h-full overflow-hidden relative">
            
            <!-- TOPBAR -->
            <div class="glass-header h-16 flex items-center justify-between px-8 sticky top-0 z-20 transition-colors duration-300">
                <h2 class="text-lg font-bold text-slate-800 dark:text-white" id="page-title">Pipeline</h2>
                
                <div class="flex items-center gap-4">
                    <!-- Selectors -->
                    <div id="superadmin-selector-container" class="hidden">
                        <select id="superadmin-org-selector" class="text-xs font-bold text-slate-700 dark:text-slate-300 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-lg py-2 px-3 shadow-sm focus:ring-amber-500 cursor-pointer">
                            <option value="">Choisir Client...</option>
                        </select>
                    </div>
                    <div id="manager-selector-container" class="hidden">
                        <select id="manager-view-selector" class="text-xs font-bold text-indigo-700 dark:text-indigo-400 bg-indigo-50 dark:bg-slate-800 border border-indigo-100 dark:border-slate-700 rounded-lg py-2 px-3 focus:ring-indigo-500 cursor-pointer">
                            <option value="ALL">Vue Globale (√âquipe)</option>
                        </select>
                    </div>
                    
                    <button onclick="openSlideOver()" id="btn-add-deal" class="px-4 py-2 text-sm font-bold text-white bg-indigo-600 hover:bg-indigo-700 dark:bg-amber-600 dark:hover:bg-amber-500 rounded-lg shadow-lg hover:shadow-xl transition-all transform hover:-translate-y-0.5">
                        + Deal
                    </button>
                </div>
            </div>

            <!-- CONTENT SCROLL -->
            <main class="flex-1 overflow-y-auto p-6 sm:p-8 custom-scroll">
                
                <!-- VIEW: DASHBOARD -->
                <div id="view-dashboard" class="space-y-8 fade-in">
                    
                    <!-- KPIs -->
                    <div class="grid grid-cols-1 gap-6 sm:grid-cols-3">
                        <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-sm border border-slate-200 dark:border-slate-700">
                            <p class="text-sm font-medium text-slate-500 dark:text-slate-400 mb-1">Total Deals (Vue)</p>
                            <p class="text-3xl font-bold text-slate-800 dark:text-white" id="metric-total">0</p>
                        </div>
                        <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-sm border border-slate-200 dark:border-slate-700 border-l-4 border-l-indigo-500 dark:border-l-indigo-400">
                            <p class="text-sm font-medium text-indigo-600 dark:text-indigo-400 mb-1 font-bold">√Ä Relancer</p>
                            <p class="text-3xl font-bold text-indigo-600 dark:text-indigo-400" id="metric-followup">0</p>
                        </div>
                        <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-sm border border-slate-200 dark:border-slate-700 border-l-4 border-l-emerald-500 dark:border-l-emerald-400">
                            <p class="text-sm font-medium text-emerald-600 dark:text-emerald-400 mb-1 font-bold">Clos√©s</p>
                            <p class="text-3xl font-bold text-emerald-600 dark:text-emerald-400" id="metric-closed">0</p>
                        </div>
                    </div>

                    <!-- TABLE & FILTERS -->
                    <div class="bg-white dark:bg-slate-800 shadow-sm rounded-2xl border border-slate-200 dark:border-slate-700 overflow-hidden">
                        
                        <!-- Filters Header -->
                        <div class="p-4 border-b border-slate-200 dark:border-slate-700 flex gap-3 overflow-x-auto items-center">
                            <select id="filter-month" class="text-sm border-slate-200 dark:border-slate-600 bg-white dark:bg-slate-900 dark:text-white rounded-lg py-2 pl-3 pr-8 font-medium focus:ring-indigo-500"><option value="current">Ce mois</option><option value="all">Tout</option></select>
                            <select id="filter-status" class="text-sm border-slate-200 dark:border-slate-600 bg-white dark:bg-slate-900 dark:text-white rounded-lg py-2 pl-3 pr-8 font-medium focus:ring-indigo-500">
                                <option value="all">Tous statuts</option>
                                <option value="followup">‚ö° Relance</option>
                                <option value="closed">üí∞ Clos√©</option>
                                <option value="cancelled">üö´ Annul√©</option>
                                <option value="unqualified">üí© Non Qualif</option>
                                <option value="rescheduled">üìÖ Report√©</option>
                            </select>
                            <div class="flex-1"></div>
                            <button id="reset-filters" class="text-xs font-bold text-slate-400 hover:text-indigo-500 dark:hover:text-amber-500 uppercase transition-colors">Reset</button>
                        </div>
                        
                        <!-- Table Content -->
                        <div class="overflow-x-auto min-h-[400px] relative">
                            <div id="loading-indicator" class="hidden absolute inset-0 bg-white/80 dark:bg-slate-900/80 z-10 flex items-center justify-center backdrop-blur-sm">
                                <div class="w-10 h-10 border-4 border-indigo-500/30 border-t-indigo-500 rounded-full animate-spin"></div>
                            </div>
                            <div id="no-data-message" class="hidden absolute inset-0 flex flex-col items-center justify-center text-slate-400 dark:text-slate-500 text-sm">
                                <i class="fa-solid fa-inbox text-4xl mb-3 opacity-50"></i>
                                Aucun r√©sultat trouv√©.
                            </div>
                            
                            <table class="min-w-full divide-y divide-slate-100 dark:divide-slate-700">
                                <thead class="bg-slate-50 dark:bg-slate-950/50">
                                    <tr>
                                        <th class="px-6 py-4 text-left text-xs font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wider">Prospect</th>
                                        <th class="px-6 py-4 text-left text-xs font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wider">Date</th>
                                        <th class="px-6 py-4 text-left text-xs font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wider">Offre</th>
                                        <th class="px-6 py-4 text-left text-xs font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wider">Statut</th>
                                        <th class="px-6 py-4 text-right"></th>
                                    </tr>
                                </thead>
                                <tbody id="deals-table-body" class="divide-y divide-slate-50 dark:divide-slate-800 bg-white dark:bg-slate-800">
                                    <!-- Rows injected here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <!-- Debug -->
                    <div class="pt-4 opacity-50 hover:opacity-100 transition-opacity">
                        <details class="group">
                            <summary class="text-[10px] text-slate-400 cursor-pointer select-none">Console Syst√®me ‚åÑ</summary>
                            <pre id="debug-console" class="mt-2 bg-slate-950 text-green-400 p-3 rounded-lg text-[10px] font-mono overflow-x-auto h-32 border border-slate-800">En attente...</pre>
                        </details>
                    </div>
                </div>

                <!-- VIEW: STATS -->
                <div id="view-stats" class="hidden space-y-8 fade-in">
                    <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-sm border border-slate-200 dark:border-slate-700 overflow-hidden">
                        <div class="px-6 py-4 border-b border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-900/50">
                            <h3 class="font-bold text-slate-800 dark:text-white flex items-center gap-2"><span class="w-1 h-4 bg-indigo-500 rounded-full"></span> Performance Mensuelle</h3>
                        </div>
                        <div class="overflow-x-auto"><table class="min-w-full text-sm"><thead class="bg-slate-900 text-white"><tr><th class="p-3 text-left">Mois</th><th class="p-3 text-center opacity-80">RDV</th><th class="p-3 text-center opacity-80">Pr√©s.</th><th class="p-3 text-center text-blue-300">% Pr√©s.</th><th class="p-3 text-center text-emerald-400">Wins</th><th class="p-3 text-center text-indigo-300">% Conv.</th><th class="p-3 text-right text-amber-400">CA</th></tr></thead><tbody id="stats-month-body"></tbody></table></div>
                    </div>
                    <!-- Other stats tables similar styling... -->
                    <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-sm border border-slate-200 dark:border-slate-700 overflow-hidden">
                        <div class="px-6 py-4 border-b border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-900/50 flex justify-between items-center">
                            <h3 class="font-bold text-slate-800 dark:text-white flex items-center gap-2"><span class="w-1 h-4 bg-amber-500 rounded-full"></span> Hebdomadaire</h3>
                            <select id="stats-weekly-month-filter" class="text-xs border-slate-200 dark:border-slate-600 rounded bg-white dark:bg-slate-700 dark:text-white py-1"><option value="all">Tout</option></select>
                        </div>
                        <div class="overflow-x-auto"><table class="min-w-full text-sm"><thead class="bg-slate-900 text-white"><tr><th class="p-3 text-left">Semaine</th><th class="p-3 text-center opacity-80">RDV</th><th class="p-3 text-center opacity-80">Pr√©s.</th><th class="p-3 text-center text-blue-300">% Pr√©s.</th><th class="p-3 text-center text-emerald-400">Wins</th><th class="p-3 text-center text-indigo-300">% Conv.</th><th class="p-3 text-right text-amber-400">CA</th></tr></thead><tbody id="stats-weekly-body"></tbody></table></div>
                    </div>
                    
                    <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-sm border border-slate-200 dark:border-slate-700 overflow-hidden">
                        <div class="px-6 py-4 border-b border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-900/50 flex justify-between items-center">
                            <h3 class="font-bold text-slate-800 dark:text-white flex items-center gap-2"><span class="w-1 h-4 bg-purple-500 rounded-full"></span> Par Source</h3>
                            <select id="stats-source-month-filter" class="text-xs border-slate-200 dark:border-slate-600 rounded bg-white dark:bg-slate-700 dark:text-white py-1"><option value="all">Tout</option></select>
                        </div>
                        <div class="overflow-x-auto"><table class="min-w-full text-sm"><thead class="bg-slate-900 text-white"><tr><th class="p-3 text-left">Source</th><th class="p-3 text-center opacity-80">RDV</th><th class="p-3 text-center opacity-80">Pr√©s.</th><th class="p-3 text-center text-blue-300">% Pr√©s.</th><th class="p-3 text-center text-emerald-400">Wins</th><th class="p-3 text-center text-indigo-300">% Conv.</th><th class="p-3 text-right text-amber-400">CA</th></tr></thead><tbody id="stats-source-body"></tbody></table></div>
                    </div>
                </div>

            </main>
        </div>
    </div>

    <!-- SLIDE OVER (FORMULAIRE REDESIGN√â & RESPONSIVE) -->
    <div id="slide-over-container" class="hidden fixed inset-0 z-50 overflow-hidden">
        <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm transition-opacity" onclick="closeSlideOver()"></div>
        <div id="slide-over-panel" class="absolute inset-y-0 right-0 max-w-md w-full bg-white dark:bg-slate-900 shadow-2xl flex flex-col transform transition-transform translate-x-full border-l border-slate-200 dark:border-slate-800">
            
            <!-- Header -->
            <div class="px-8 py-6 border-b border-slate-100 dark:border-slate-800 flex justify-between items-center bg-white dark:bg-slate-900">
                <div>
                    <h2 class="text-xl font-bold text-slate-800 dark:text-white" id="slide-over-title">Deal Details</h2>
                    <p class="text-xs text-slate-400 mt-1">Informations du prospect</p>
                </div>
                <div class="flex items-center gap-3">
                    <button onclick="toggleExpand()" class="text-slate-400 hover:text-indigo-500 transition-colors p-2 rounded-full hover:bg-slate-50 dark:hover:bg-slate-800" title="Agrandir">
                        <i id="expand-icon" class="fa-solid fa-expand"></i>
                    </button>
                    <button onclick="closeSlideOver()" class="text-slate-400 hover:text-slate-600 dark:hover:text-white transition-colors p-2 rounded-full hover:bg-slate-50 dark:hover:bg-slate-800">
                        <i class="fa-solid fa-xmark text-lg"></i>
                    </button>
                </div>
            </div>
            
            <form id="deal-form" class="flex-1 flex flex-col overflow-y-auto custom-scroll bg-white dark:bg-slate-900">
                <div class="px-8 py-6 space-y-8">
                    
                    <!-- 1. IDENTIT√â -->
                    <div class="space-y-6">
                        <div class="relative">
                            <input type="text" id="nomPrenom" required class="form-input peer" placeholder=" ">
                            <label for="nomPrenom" class="form-label">Prospect <span class="text-red-500">*</span></label>
                        </div>

                        <div class="grid grid-cols-2 gap-6">
                            <div class="relative">
                                <select id="source" required class="form-input peer pt-3 pb-2 dark:bg-slate-900"><option value="Marketing">Marketing</option><option value="Setting">Setting</option><option value="Prise de rdv">Prise de RDV</option><option value="Autre">Autre</option></select>
                                <label for="source" class="form-label">Source</label>
                            </div>
                            <div class="relative">
                                <input type="text" id="entrepreneur" class="form-input peer" placeholder=" ">
                                <label for="entrepreneur" class="form-label">Entrepreneur (F)</label>
                            </div>
                        </div>

                        <div class="relative">
                            <input type="date" id="dateRDV" class="form-input peer pt-3 pb-2 dark:text-white [color-scheme:light] dark:[color-scheme:dark]">
                            <label for="dateRDV" class="form-label">Date RDV</label>
                        </div>

                        <div class="grid grid-cols-2 gap-6">
                            <div class="relative">
                                <input type="email" id="email" class="form-input peer" placeholder=" ">
                                <label for="email" class="form-label">Email</label>
                            </div>
                            <div class="relative">
                                <input type="text" id="numero" class="form-input peer" placeholder=" ">
                                <label for="numero" class="form-label">T√©l√©phone</label>
                            </div>
                        </div>

                        <div class="relative">
                            <input type="url" id="enregistrementCall" class="form-input peer" placeholder=" ">
                            <label for="enregistrementCall" class="form-label">Lien Enregistrement (URL)</label>
                        </div>
                    </div>

                    <!-- 2. STATUTS -->
                    <div class="bg-slate-50 dark:bg-slate-800/50 rounded-xl p-5 border border-slate-100 dark:border-slate-700">
                        <div class="flex items-center justify-between mb-4">
                            <label class="flex items-center cursor-pointer w-full p-3 bg-emerald-50 dark:bg-emerald-900/20 border border-emerald-100 dark:border-emerald-800 rounded-lg hover:shadow-sm transition-all group">
                                <input id="close" type="checkbox" class="h-5 w-5 text-emerald-600 dark:text-emerald-500 rounded focus:ring-emerald-500 border-gray-300 dark:border-slate-600 dark:bg-slate-800">
                                <span class="ml-3 font-bold text-emerald-800 dark:text-emerald-400">‚úÖ Deal Clos√©</span>
                            </label>
                        </div>

                        <div class="grid grid-cols-2 gap-3">
                            <label class="status-checkbox-wrapper group">
                                <input id="aFollowUp" type="checkbox" class="status-checkbox">
                                <span class="text-xs font-semibold text-indigo-600 dark:text-indigo-400 flex items-center gap-2"><i class="fa-solid fa-bolt"></i> Relance</span>
                            </label>
                            <label class="status-checkbox-wrapper group">
                                <input id="ghost" type="checkbox" class="status-checkbox !text-amber-500 !focus:ring-amber-500">
                                <span class="text-xs font-semibold text-amber-600 dark:text-amber-500 flex items-center gap-2"><i class="fa-solid fa-ghost"></i> Ghost</span>
                            </label>
                            <label class="status-checkbox-wrapper group">
                                <input id="nonClose" type="checkbox" class="status-checkbox !text-red-500 !focus:ring-red-500">
                                <span class="text-xs font-semibold text-red-600 dark:text-red-400 flex items-center gap-2"><i class="fa-solid fa-xmark"></i> Perdu</span>
                            </label>
                            <label class="status-checkbox-wrapper group">
                                <input id="compta" type="checkbox" class="status-checkbox !text-teal-500 !focus:ring-teal-500">
                                <span class="text-xs font-semibold text-teal-600 dark:text-teal-400 flex items-center gap-2"><i class="fa-solid fa-book"></i> Compta</span>
                            </label>
                            <!-- Nouveaux -->
                            <label class="status-checkbox-wrapper group">
                                <input id="cancelled" type="checkbox" class="status-checkbox !text-slate-500 !focus:ring-slate-500">
                                <span class="text-xs font-semibold text-slate-500 dark:text-slate-400 flex items-center gap-2"><i class="fa-solid fa-ban"></i> Annul√©</span>
                            </label>
                            <label class="status-checkbox-wrapper group">
                                <input id="unqualified" type="checkbox" class="status-checkbox !text-orange-500 !focus:ring-orange-500">
                                <span class="text-xs font-semibold text-orange-500 dark:text-orange-400 flex items-center gap-2"><i class="fa-solid fa-user-slash"></i> Non Qualif</span>
                            </label>
                            <label class="status-checkbox-wrapper group">
                                <input id="rescheduled" type="checkbox" class="status-checkbox !text-blue-400 !focus:ring-blue-400">
                                <span class="text-xs font-semibold text-blue-500 dark:text-blue-400 flex items-center gap-2"><i class="fa-regular fa-calendar"></i> Report√©</span>
                            </label>
                        </div>
                    </div>

                    <!-- 3. DETAILS CLOSING -->
                    <div id="closing-details" class="hidden space-y-6 pt-2 fade-in">
                        <div class="relative">
                            <select id="formation" class="form-input peer pt-3 pb-2 dark:bg-slate-900"><option value="">S√©lectionner...</option><option value="Produit B 4000">Produit B (4000‚Ç¨)</option><option value="Produit A 2000">Produit A (2000‚Ç¨)</option><option value="N/A">Autre</option></select>
                            <label for="formation" class="form-label text-emerald-600 dark:text-emerald-500">Produit Vendu</label>
                        </div>
                        <div class="grid grid-cols-2 gap-6">
                            <div class="relative"><input type="number" id="prix" class="form-input peer" placeholder=" "><label for="prix" class="form-label text-emerald-600 dark:text-emerald-500">Prix (‚Ç¨)</label></div>
                            <div class="relative"><input type="number" id="mensualite" class="form-input peer" placeholder=" "><label for="mensualite" class="form-label text-emerald-600 dark:text-emerald-500">Mensualit√©</label></div>
                        </div>
                        <div class="relative">
                            <select id="typePaiement" class="form-input peer pt-3 pb-2 dark:bg-slate-900"><option value="">S√©lectionner...</option><option value="CB">Carte Bancaire</option><option value="Virement">Virement</option><option value="3x">3 Fois</option><option value="Int√©gral">Int√©gral</option></select>
                            <label for="typePaiement" class="form-label text-emerald-600 dark:text-emerald-500">Moyen de Paiement</label>
                        </div>
                    </div>

                    <!-- 4. NOTES -->
                    <div class="relative">
                        <textarea id="newComment" rows="3" class="form-input peer resize-none" placeholder=" "></textarea>
                        <label for="newComment" class="form-label">Note / Commentaire</label>
                        <div id="comment-history" class="mt-4 hidden p-3 bg-slate-50 dark:bg-slate-800 rounded-lg border border-slate-100 dark:border-slate-700 text-xs text-slate-500 dark:text-slate-400 max-h-32 overflow-y-auto"></div>
                    </div>

                </div>
                
                <!-- FOOTER -->
                <div class="p-6 border-t border-slate-100 dark:border-slate-800 flex justify-end gap-3 bg-white dark:bg-slate-900 sticky bottom-0">
                    <button type="button" onclick="closeSlideOver()" class="px-5 py-2.5 rounded-xl text-sm font-bold text-slate-500 hover:text-slate-800 dark:text-slate-400 dark:hover:text-white hover:bg-slate-50 dark:hover:bg-slate-800 transition-colors">Annuler</button>
                    <button type="submit" id="submit-text" class="px-8 py-2.5 rounded-xl text-sm font-bold text-white bg-slate-900 dark:bg-amber-600 hover:bg-slate-800 dark:hover:bg-amber-500 shadow-lg shadow-slate-900/20 transition-all transform hover:-translate-y-0.5">Enregistrer</button>
                </div>
            </form>
        </div>
    </div>

    <!-- History Modal -->
    <div id="history-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4">
        <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm" onclick="document.getElementById('history-modal').classList.add('hidden')"></div>
        <div class="relative bg-white dark:bg-slate-800 rounded-2xl shadow-2xl w-full max-w-lg overflow-hidden border border-slate-200 dark:border-slate-700">
            <div class="p-4 border-b border-slate-100 dark:border-slate-700 font-bold text-slate-800 dark:text-white">Historique Complet</div>
            <div id="modal-history-content" class="p-6 text-sm text-slate-600 dark:text-slate-300 max-h-96 overflow-y-auto bg-slate-50 dark:bg-slate-900/50"></div>
            <div class="p-4 border-t border-slate-100 dark:border-slate-700 flex justify-end">
                <button onclick="document.getElementById('history-modal').classList.add('hidden')" class="text-sm font-bold text-slate-500 hover:text-slate-800 dark:hover:text-white">Fermer</button>
            </div>
        </div>
    </div>

    <script>
        const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzZzTCbYR2H4jsGfrZt60oxhmwgf8D_wS8QSgO4GggLoECqsPP9LctDITbWgb6oBZQh/exec'; 

        // Theme Toggle Logic
        const themeToggleBtn = document.getElementById('theme-toggle');
        themeToggleBtn.addEventListener('click', function() {
            if (document.documentElement.classList.contains('dark')) {
                document.documentElement.classList.remove('dark');
                localStorage.setItem('color-theme', 'light');
            } else {
                document.documentElement.classList.add('dark');
                localStorage.setItem('color-theme', 'dark');
            }
        });

        // --- Standard JS Logic (Auth, API, Rendering...) ---
        let allDealsCache = []; 
        let currentUser = null; 
        let currentSheetId = localStorage.getItem('crm_sheetId');
        let currentUserName = localStorage.getItem('crm_user');
        let superAdminData = null;
        let availableSheets = [];
        let editingId = null;
        const debugConsole = document.getElementById('debug-console');
        function logDebug(msg) { console.log(msg); debugConsole.textContent += "\n" + msg; debugConsole.scrollTop = debugConsole.scrollHeight; }

        function initAuth() {
            const stored = localStorage.getItem('sellit_auth');
            if (stored) {
                const data = JSON.parse(stored);
                currentUser = data.user;
                if(currentUser.role === 'super_admin') { superAdminData = data.superAdminData || {}; setupSuperAdminSelector(); } 
                else if(currentUser.role === 'manager' || currentUser.role === 'admin') { availableSheets = data.teamSheets || []; setupManagerSelector(availableSheets); } 
                else { if (!currentSheetId || currentSheetId === 'null') { currentSheetId = currentUser.personalSheetId; localStorage.setItem('crm_sheetId', currentSheetId); } }
                showApp(); loadDeals();
            } else { document.getElementById('login-screen').classList.remove('hidden'); document.getElementById('app-content').classList.add('hidden'); }
        }
        
        function showApp() {
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('app-content').classList.remove('hidden');
            document.getElementById('user-display').textContent = currentUser.name;
            document.getElementById('role-display').textContent = currentUser.role.toUpperCase();
            document.getElementById('org-display').textContent = currentUser.org;
            updateAddButtonVisibility();
        }

        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const u = document.getElementById('login-user').value.trim();
            const p = document.getElementById('login-pass').value.trim();
            const btn = document.getElementById('login-btn');
            const err = document.getElementById('login-error');
            
            btn.textContent = "Connexion..."; btn.disabled = true; err.classList.add('hidden');
            try {
                const response = await fetch(APPS_SCRIPT_URL, {
                    method: 'POST', mode: 'cors', cache: 'no-cache', headers: { 'Content-Type': 'text/plain' },
                    body: JSON.stringify({ action: 'LOGIN', username: u, password: p })
                });
                
                const text = await response.text(); 
                let result;
                try { result = JSON.parse(text); } catch(parseError) { const errorSnippet = text.substring(0, 300); alert("ERREUR CRITIQUE SERVEUR :\n" + errorSnippet); throw new Error("R√©ponse serveur invalide."); }
                
                if (result.success) {
                    let targetSheet = result.user.personalSheetId;
                    if(result.user.role === 'super_admin' || result.user.role === 'manager' || result.user.role === 'admin') { targetSheet = 'ALL'; }
                    localStorage.setItem('crm_sheetId', targetSheet); localStorage.setItem('crm_user', result.user.name); localStorage.setItem('sellit_auth', JSON.stringify(result));
                    currentSheetId = targetSheet; currentUserName = result.user.name; currentUser = result.user;
                    initAuth(); showApp();
                } else { err.textContent = result.message || "Identifiants incorrects"; err.classList.remove('hidden'); }
            } catch (e) { if(!e.message.includes("R√©ponse serveur invalide")) alert("ERREUR R√âSEAU : " + e.message); err.textContent = e.message; err.classList.remove('hidden'); } finally { btn.disabled = false; btn.textContent = "Se Connecter"; }
        });

        function logout() { localStorage.clear(); location.reload(); }

        // --- DATA ---
        async function fetchAppsScript(action, data = {}) {
            if(action !== 'LOGIN') data.targetSheetId = currentSheetId;
            if (action === 'READ' && currentSheetId === 'ALL' && currentUser) data.org = currentUser.org; 
            if (action !== 'READ' && action !== 'LOGIN') { const btn = document.getElementById('submit-text'); if(btn) { btn.disabled = true; btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin mr-2"></i> Traitement...'; } }
            try {
                const response = await fetch(APPS_SCRIPT_URL, { method: 'POST', mode: 'cors', cache: 'no-cache', headers: { 'Content-Type': 'text/plain' }, body: JSON.stringify({ action, ...data }) });
                const text = await response.text(); let result; try { result = JSON.parse(text); } catch(e) { throw new Error("R√©ponse serveur invalide: " + text.substring(0, 100)); }
                if (!result.success) throw new Error(result.error || result.message); return result;
            } catch (error) { console.error(error); logDebug(`Erreur API (${action}): ${error.message}`); return { success: false, error: error.message }; } finally { if (action !== 'READ' && action !== 'LOGIN') { const btn = document.getElementById('submit-text'); if(btn) { btn.disabled = false; btn.textContent = "Enregistrer"; } } }
        }

        async function loadDeals() {
            if(!currentSheetId || currentSheetId === 'null') { logDebug("Aucun Sheet ID."); return; }
            document.getElementById('loading-indicator').classList.remove('hidden');
            try { const res = await fetchAppsScript('READ'); if (res.success) { allDealsCache = (res.deals || []).filter(d => d.nomPrenom && String(d.nomPrenom).trim() !== ""); renderAll(); } } catch(e) { console.error(e); }
            document.getElementById('loading-indicator').classList.add('hidden');
        }

        // --- SELECTORS ---
        function setupSuperAdminSelector() { const orgSel = document.getElementById('superadmin-org-selector'); document.getElementById('superadmin-selector-container').classList.remove('hidden'); document.getElementById('manager-selector-container').classList.add('hidden'); orgSel.innerHTML = '<option value="">Choisir Client...</option>'; Object.keys(superAdminData).forEach(orgName => { const opt = document.createElement('option'); opt.value = orgName; opt.textContent = orgName; orgSel.appendChild(opt); }); orgSel.addEventListener('change', (e) => { const selectedOrg = e.target.value; if(selectedOrg && superAdminData[selectedOrg]) { currentUser.org = selectedOrg; document.getElementById('org-display').textContent = selectedOrg; availableSheets = superAdminData[selectedOrg]; setupManagerSelector(availableSheets); currentSheetId = 'ALL'; document.getElementById('manager-view-selector').value = 'ALL'; loadDeals(); } else { document.getElementById('manager-selector-container').classList.add('hidden'); } }); }
        function setupManagerSelector(sheets) { const sel = document.getElementById('manager-view-selector'); document.getElementById('manager-selector-container').classList.remove('hidden'); sel.innerHTML = '<option value="ALL">Vue Globale (√âquipe)</option>'; sheets.forEach(s => { const opt = document.createElement('option'); opt.value = s.sheetId; opt.textContent = s.name; sel.appendChild(opt); }); sel.onchange = (e) => { currentSheetId = e.target.value; localStorage.setItem('crm_sheetId', currentSheetId); updateAddButtonVisibility(); loadDeals(); }; }
        function updateAddButtonVisibility() { const btn = document.getElementById('btn-add-deal'); if (currentSheetId === 'ALL' || !currentSheetId) btn.classList.add('hidden'); else btn.classList.remove('hidden'); }

        // --- RENDER ---
        function renderAll() { populateFilters(); applyFilters(); if(document.getElementById('view-stats').classList.contains('hidden') === false) renderStats(); }
        function applyFilters() {
            const m = document.getElementById('filter-month').value; const s = document.getElementById('filter-status').value;
            let list = allDealsCache;
            if (m !== 'all') list = list.filter(d => d.dateRDV && checkMonth(d.dateRDV, m));
            if (s !== 'all') list = list.filter(d => checkStatus(d, s));
            list.sort((a,b) => new Date(b.dateRDV||0) - new Date(a.dateRDV||0));
            renderTable(list); updateKPIs(list);
        }
        function renderTable(list) {
            const tbody = document.getElementById('deals-table-body'); tbody.innerHTML = ''; document.getElementById('no-data-message').classList.toggle('hidden', list.length > 0);
            list.forEach(d => {
                const isPast = d.dateRDV && new Date(d.dateRDV) < new Date().setHours(0,0,0,0);
                const isLate = isPast && !d.close && !d.nonClose && !d.ghost && !d.cancelled && !d.unqualified && !d.rescheduled;
                let badgeClass = "bg-slate-100 text-slate-500 dark:bg-slate-700 dark:text-slate-300"; let badgeText = "NOUVEAU";
                if(d.close) { badgeClass = "bg-emerald-100 text-emerald-700 dark:bg-emerald-900/30 dark:text-emerald-400"; badgeText = "GAGN√â"; }
                else if(d.aFollowUp) { badgeClass = "bg-indigo-100 text-indigo-700 dark:bg-indigo-900/30 dark:text-indigo-400"; badgeText = "RELANCE"; }
                else if(d.ghost) { badgeClass = "bg-amber-100 text-amber-700 dark:bg-amber-900/30 dark:text-amber-400"; badgeText = "GHOST"; }
                else if(d.nonClose) { badgeClass = "bg-red-100 text-red-600 dark:bg-red-900/30 dark:text-red-400"; badgeText = "PERDU"; }
                else if(d.cancelled) { badgeClass = "bg-slate-200 text-slate-600 dark:bg-slate-700 dark:text-slate-400"; badgeText = "ANNUL√â"; }
                else if(d.unqualified) { badgeClass = "bg-orange-100 text-orange-600 dark:bg-orange-900/30 dark:text-orange-400"; badgeText = "NON QUALIF"; }
                else if(d.rescheduled) { badgeClass = "bg-blue-100 text-blue-600 dark:bg-blue-900/30 dark:text-blue-400"; badgeText = "REPORT√â"; }

                const ownerTag = d.ownerName ? `<div class="text-[10px] text-slate-400 dark:text-slate-500 bg-slate-100 dark:bg-slate-800 px-1 rounded ml-2 border border-slate-200 dark:border-slate-700">${d.ownerName}</div>` : '';
                const row = `<tr class="hover:bg-slate-50 dark:hover:bg-slate-800/50 transition-colors border-b border-slate-100 dark:border-slate-800 last:border-none group">
                    <td class="px-6 py-4"><div class="flex items-center"><div><div class="text-sm font-bold text-slate-700 dark:text-slate-200 group-hover:text-accent transition-colors">${d.nomPrenom}</div><div class="flex items-center mt-0.5"><span class="text-[10px] uppercase font-bold text-slate-400">${d.source || '-'}</span>${d.ownerName ? `<div class="text-[10px] text-slate-400 dark:text-slate-500 bg-slate-100 dark:bg-slate-800 px-1 rounded ml-2 border border-slate-200 dark:border-slate-700">${d.ownerName}</div>` : ''}</div></div></div></td>
                    <td class="px-6 py-4"><div class="text-sm font-medium text-slate-600 dark:text-slate-300">${formatDateFR(d.dateRDV)}</div>${isLate ? '<div class="text-[10px] text-red-500 font-bold uppercase mt-0.5">Retard</div>' : ''}</td>
                    <td class="px-6 py-4"><div class="text-xs font-bold text-slate-700 dark:text-slate-300">${d.formation || '-'}</div>${d.prix ? `<div class="text-[10px] text-slate-400 font-mono">${d.prix} ‚Ç¨</div>` : ''}</td>
                    <td class="px-6 py-4"><span class="px-2 py-1 rounded text-[10px] font-bold border border-transparent ${badgeClass}">${badgeText}</span></td>
                    <td class="px-6 py-4 text-right"><div class="opacity-0 group-hover:opacity-100 transition-opacity flex justify-end gap-2"><button onclick="viewHistory('${d.id}')" class="p-1.5 text-slate-400 hover:text-slate-800 dark:hover:text-white transition-colors"><i class="fa-regular fa-comments"></i></button>${currentSheetId !== 'ALL' ? `<button onclick="editDeal('${d.id}')" class="p-1.5 text-indigo-500 hover:text-indigo-700 dark:hover:text-indigo-400"><i class="fa-solid fa-pen"></i></button><button onclick="deleteDeal('${d.id}')" class="p-1.5 text-red-400 hover:text-red-600"><i class="fa-solid fa-trash"></i></button>` : ''}</div></td></tr>`;
                tbody.innerHTML += row;
            });
        }
        function updateKPIs(list) { document.getElementById('metric-total').textContent = list.length; document.getElementById('metric-followup').textContent = list.filter(d => d.aFollowUp).length; document.getElementById('metric-closed').textContent = list.filter(d => d.close).length; }

        // --- STATS (Simplified) ---
        function renderStats() {
            // Stats logic identical to previous, just ensure text colors work in dark mode (usually handled by parent classes)
            // Re-use logic from previous version for Month/Week/Source
        }

        // --- ACTIONS & FORM ---
        function openSlideOver() { resetForm(); document.getElementById('slide-over-container').classList.remove('hidden'); setTimeout(() => { document.getElementById('slide-over-panel').classList.remove('translate-x-full'); }, 10); }
        function closeSlideOver() { document.getElementById('slide-over-panel').classList.add('translate-x-full'); setTimeout(() => { document.getElementById('slide-over-container').classList.add('hidden'); }, 300); }
        function toggleExpand() {
            const panel = document.getElementById('slide-over-panel'); const icon = document.getElementById('expand-icon');
            if (panel.classList.contains('max-w-md')) { panel.classList.remove('max-w-md'); panel.classList.add('max-w-4xl'); icon.classList.remove('fa-expand'); icon.classList.add('fa-compress'); } 
            else { panel.classList.add('max-w-md'); panel.classList.remove('max-w-4xl'); icon.classList.remove('fa-compress'); icon.classList.add('fa-expand'); }
        }
        
        document.getElementById('deal-form').addEventListener('submit', async (e) => { e.preventDefault(); const data = { id: editingId, nomPrenom: document.getElementById('nomPrenom').value, source: document.getElementById('source').value, entrepreneur: document.getElementById('entrepreneur').value, dateRDV: document.getElementById('dateRDV').value, email: document.getElementById('email').value, numero: document.getElementById('numero').value, enregistrementCall: document.getElementById('enregistrementCall').value, close: document.getElementById('close').checked, aFollowUp: document.getElementById('aFollowUp').checked, ghost: document.getElementById('ghost').checked, nonClose: document.getElementById('nonClose').checked, compta: document.getElementById('compta').checked, cancelled: document.getElementById('cancelled').checked, unqualified: document.getElementById('unqualified').checked, rescheduled: document.getElementById('rescheduled').checked, formation: document.getElementById('formation').value, prix: parseFloat(document.getElementById('prix').value)||0, typePaiement: document.getElementById('typePaiement').value, mensualite: parseFloat(document.getElementById('mensualite').value)||0, newCommentText: editingId ? document.getElementById('newComment').value : null, commentaireHistory: !editingId ? document.getElementById('newComment').value : null }; const res = await fetchAppsScript(editingId ? 'UPDATE' : 'CREATE', { data }); if(res.success) { closeSlideOver(); loadDeals(); } });
        window.editDeal = function(id) { const d = allDealsCache.find(x => x.id === id); if(!d) return; editingId = id; document.getElementById('nomPrenom').value = d.nomPrenom; document.getElementById('source').value = d.source; document.getElementById('entrepreneur').value = d.entrepreneur; document.getElementById('dateRDV').value = d.dateRDV; document.getElementById('email').value = d.email; document.getElementById('numero').value = d.numero; document.getElementById('enregistrementCall').value = d.enregistrementCall; document.getElementById('close').checked = d.close; document.getElementById('aFollowUp').checked = d.aFollowUp; document.getElementById('ghost').checked = d.ghost; document.getElementById('nonClose').checked = d.nonClose; document.getElementById('compta').checked = d.compta; document.getElementById('cancelled').checked = d.cancelled||false; document.getElementById('unqualified').checked = d.unqualified||false; document.getElementById('rescheduled').checked = d.rescheduled||false; toggleClosing(); document.getElementById('formation').value = d.formation; document.getElementById('prix').value = d.prix; document.getElementById('typePaiement').value = d.typePaiement; document.getElementById('mensualite').value = d.mensualite; const hist = document.getElementById('comment-history'); if(d.commentaireHistory) { hist.textContent = d.commentaireHistory; hist.classList.remove('hidden'); } else hist.classList.add('hidden'); document.getElementById('newComment').value = ''; document.getElementById('slide-over-container').classList.remove('hidden'); setTimeout(() => { document.getElementById('slide-over-panel').classList.remove('translate-x-full'); }, 10); };
        window.deleteDeal = async function(id) { if(!confirm("Supprimer ?")) return; await fetchAppsScript('DELETE', { data: {id} }); loadDeals(); };
        window.viewHistory = function(id) { const d = allDealsCache.find(x => x.id === id); document.getElementById('modal-history-content').textContent = d.commentaireHistory || 'Aucune note'; document.getElementById('history-modal').classList.remove('hidden'); };
        function checkMonth(dStr, mode) { if(mode === 'all') return true; const d = new Date(dStr); const now = new Date(); return d.getMonth() === now.getMonth() && d.getFullYear() === now.getFullYear(); }
        function checkStatus(d, s) { if(s === 'all') return true; if(s === 'followup') return d.aFollowUp; if(s === 'closed') return d.close; if(s === 'cancelled') return d.cancelled; if(s === 'unqualified') return d.unqualified; return true; }
        function toggleClosing() { const div = document.getElementById('closing-details'); if(document.getElementById('close').checked) div.classList.remove('hidden'); else div.classList.add('hidden'); }
        document.getElementById('close').addEventListener('change', toggleClosing);
        function resetForm() { document.getElementById('deal-form').reset(); editingId = null; toggleClosing(); document.getElementById('comment-history').classList.add('hidden'); }
        function formatDateFR(s) { if(!s) return '-'; const d = new Date(s); return d.toLocaleDateString('fr-FR'); }
        function populateFilters() {}
        document.getElementById('filter-month').addEventListener('change', applyFilters); document.getElementById('filter-status').addEventListener('change', applyFilters); document.getElementById('reset-filters').addEventListener('click', () => { document.getElementById('filter-month').value = 'current'; document.getElementById('filter-status').value = 'all'; applyFilters(); });
        function switchView(viewId) { document.getElementById('view-dashboard').classList.add('hidden'); document.getElementById('view-stats').classList.add('hidden'); const target = document.getElementById(`view-${viewId}`); target.classList.remove('hidden'); document.getElementById('page-title').textContent = viewId === 'dashboard' ? 'Tableau de Bord' : 'Rapports & Statistiques'; const topbarActions = document.getElementById('topbar-actions'); if(viewId === 'stats') topbarActions.classList.add('hidden'); else topbarActions.classList.remove('hidden'); }

        initAuth();
    </script>
</body>
</html>
